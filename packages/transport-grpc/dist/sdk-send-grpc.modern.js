import{invariant as e}from"@onflow/util-invariant";import{ExecuteScriptAtBlockIDRequest as t,AccessAPI as n,ExecuteScriptAtBlockHeightRequest as s,ExecuteScriptAtLatestBlockRequest as r,GetAccountAtBlockHeightRequest as o,GetAccountAtLatestBlockRequest as a,GetBlockHeaderByIDRequest as i,GetBlockHeaderByHeightRequest as c,GetLatestBlockHeaderRequest as d,GetBlockByIDRequest as u,GetBlockByHeightRequest as g,GetLatestBlockRequest as l,GetCollectionByIDRequest as f,GetEventsForHeightRangeRequest as p,GetEventsForBlockIDsRequest as S,GetTransactionRequest as m,PingRequest as B,Transaction as k,SendTransactionRequest as y}from"@onflow/protobuf";import{grpc as b}from"@improbable-eng/grpc-web";import{NodeHttpTransport as h}from"@improbable-eng/grpc-web-node-http-transport";import{sansPrefix as I,withPrefix as w}from"@onflow/util-address";async function x(t,n,s,r){e(r.config,"SDK GRPC Unary Error: context.config must be defined.");const o=await r.config().get("grpc.metadata",{});return new Promise((e,r)=>{b.unary(n,{request:s,host:t,metadata:new b.Metadata(o),onEnd:({status:t,statusMessage:n,message:s})=>{t===b.Code.OK?e(s):r(new Error(n))}})})}b.setDefaultTransport(h());const E=(e,t)=>t.Buffer.from(JSON.stringify(e),"utf8");function G(e,t,n){let s=t.response();return s.tag=e.tag,s.encodedData=JSON.parse(t.Buffer.from(n.getValue_asU8()).toString("utf8")),s}async function D(o,a={},i={}){return e(i.node,"SDK Send Execute Script Error: opts.node must be defined."),e(a.response,"SDK Send Execute Script Error: context.response must be defined."),e(a.Buffer,"SDK Send Execute Script Error: context.Buffer must be defined."),(o=await o).block.id?await async function(e,s,r){const o=r.unary||x,a=new t;a.setBlockId(((e,t)=>t.Buffer.from(e,"hex"))(e.block.id,s));const i=s.Buffer.from(e.message.cadence,"utf8");e.message.arguments.forEach(t=>a.addArguments(E(e.arguments[t].asArgument,s))),a.setScript(i);const c=await o(r.node,n.ExecuteScriptAtBlockID,a,s);return G(e,s,c)}(o,a,i):o.block.height?await async function(e,t,r){const o=r.unary||x,a=new s;a.setBlockHeight(Number(e.block.height));const i=t.Buffer.from(e.message.cadence,"utf8");e.message.arguments.forEach(n=>a.addArguments(E(e.arguments[n].asArgument,t))),a.setScript(i);const c=await o(r.node,n.ExecuteScriptAtBlockHeight,a,t);return G(e,t,c)}(o,a,i):await async function(e,t,s){const o=s.unary||x,a=new r,i=t.Buffer.from(e.message.cadence,"utf8");e.message.arguments.forEach(n=>a.addArguments(E(e.arguments[n].asArgument,t))),a.setScript(i);const c=await o(s.node,n.ExecuteScriptAtLatestBlock,a,t);return G(e,t,c)}(o,a,i)}function A(){return A=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},A.apply(this,arguments)}const K=(e,t)=>t.Buffer.from(e).toString("hex"),L=(e,t)=>((e,t,n)=>n.Buffer.from(e.padStart(16,0),"hex"))(e,0,t),v={1:"SHA2_256",2:"SHA2_384",3:"SHA3_256",4:"SHA3_384",5:"KMAC128_BLS_BLS12_381"},_={1:"ECDSA_P256",2:"ECDSA_secp256k1",3:"BLS_BLS12_381"};function T(e,t,n){let s=t.response();s.tag=e.tag;const r=n.getAccount();let o;const a=(o=r.getContractsMap())?o.getEntryList().reduce((e,n)=>A({},e,{[n[0]]:t.Buffer.from(n[1]||new UInt8Array).toString("utf8")}),{}):{};return s.account={address:w(K(r.getAddress_asU8(),t)),balance:r.getBalance(),code:t.Buffer.from(r.getCode_asU8()||new UInt8Array).toString("utf8"),contracts:a,keys:r.getKeysList().map(e=>({index:e.getIndex(),publicKey:K(e.getPublicKey_asU8(),t),signAlgo:e.getSignAlgo(),signAlgoString:_[e.getSignAlgo()],hashAlgo:e.getHashAlgo(),hashAlgoString:v[e.getHashAlgo()],weight:e.getWeight(),sequenceNumber:e.getSequenceNumber(),revoked:e.getRevoked()}))},s}async function U(t,s={},r={}){return e(r.node,"SDK Send Get Account Error: opts.node must be defined."),e(s.response,"SDK Get Account Error: context.response must be defined."),e(s.Buffer,"SDK Get Account Error: context.Buffer must be defined."),null!==(t=await t).block.height?await async function(e,t,s){const r=s.unary||x,a=new o;return a.setBlockHeight(Number(e.block.height)),a.setAddress(L(I(e.account.addr),t)),T(e,t,await r(s.node,n.GetAccountAtBlockHeight,a,t))}(t,s,r):await async function(e,t,s){const r=s.unary||x,o=new a;return o.setAddress(L(I(e.account.addr),t)),T(e,t,await r(s.node,n.GetAccountAtLatestBlock,o,t))}(t,s,r)}const H=(e,t)=>t.Buffer.from(e).toString("hex");function N(e,t,n){const s=n.getBlock(),r=t.response();return r.tag=e.tag,r.blockHeader={id:H(s.getId_asU8(),t),parentId:H(s.getParentId_asU8(),t),height:s.getHeight(),timestamp:s.getTimestamp().toDate().toISOString()},r}async function R(t,s={},r={}){e(r.node,"SDK Send Get Block Header Error: opts.node must be defined."),e(s.response,"SDK Send Get Block Header Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Block Header Error: context.Buffer must be defined.");const o=null!==(t=await t).block.height;return null!==t.block.id?await async function(e,t,s){const r=s.unary||x,o=new i;return o.setId(((e,t)=>t.Buffer.from(e,"hex"))(e.block.id,t)),N(e,t,await r(s.node,n.GetBlockHeaderByID,o,t))}(t,s,r):o?await async function(e,t,s){const r=s.unary||x,o=new c;return o.setHeight(Number(e.block.height)),N(e,t,await r(s.node,n.GetBlockHeaderByHeight,o,t))}(t,s,r):await async function(e,t,s){var r;const o=s.unary||x,a=new d;return null!=(r=e.block)&&r.isSealed&&a.setIsSealed(e.block.isSealed),N(e,t,await o(s.node,n.GetLatestBlockHeader,a,t))}(t,s,r)}const C=(e,t)=>t.Buffer.from(e).toString("hex");function P(e,t,n){const s=n.getBlock(),r=s.getCollectionGuaranteesList(),o=s.getBlockSealsList(),a=s.getSignaturesList().map(e=>C(e,t)),i=t.response();return i.tag=e.tag,i.block={id:C(s.getId_asU8(),t),parentId:C(s.getParentId_asU8(),t),height:s.getHeight(),timestamp:s.getTimestamp().toDate().toISOString(),collectionGuarantees:r.map(e=>({collectionId:C(e.getCollectionId_asU8(),t),signatures:e.getSignaturesList().map(e=>C(e,t))})),blockSeals:o.map(e=>({blockId:C(e.getBlockId_asU8(),t),executionReceiptId:C(e.getExecutionReceiptId_asU8(),t),executionReceiptSignatures:e.getExecutionReceiptSignaturesList().map(e=>C(e,t)),resultApprovalSignatures:e.getResultApprovalSignaturesList().map(e=>C(e,t))})),signatures:a},i}async function O(t,s={},r={}){e(r.node,"SDK Send Get Block Error: opts.node must be defined."),e(s.response,"SDK Send Get Block Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Block Error: context.Buffer must be defined.");const o=null!==(t=await t).block.height;return null!==t.block.id?await async function(e,t,s){const r=s.unary||x,o=new u;return o.setId(((e,t)=>t.Buffer.from(e,"hex"))(e.block.id,t)),P(e,t,await r(s.node,n.GetBlockByID,o,t))}(t,s,r):o?await async function(e,t,s){const r=s.unary||x,o=new g;return o.setHeight(Number(e.block.height)),P(e,t,await r(s.node,n.GetBlockByHeight,o,t))}(t,s,r):await async function(e,t,s){var r;const o=s.unary||x,a=new l;return null!=(r=e.block)&&r.isSealed&&a.setIsSealed(e.block.isSealed),P(e,t,await o(s.node,n.GetLatestBlock,a,t))}(t,s,r)}const q=(e,t)=>t.Buffer.from(e).toString("hex");async function j(t,s={},r={}){e(r.node,"SDK Send Get Collection Error: opts.node must be defined."),e(s.response,"SDK Send Get Collection Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Collection Error: context.Buffer must be defined.");const o=r.unary||x;t=await t;const a=new f;a.setId(((e,t)=>t.Buffer.from(e,"hex"))(t.collection.id,s));const i=(await o(r.node,n.GetCollectionByID,a,s)).getCollection(),c=s.response();return c.tag=t.tag,c.collection={id:q(i.getId_asU8(),s),transactionIds:i.getTransactionIdsList().map(e=>q(e,s))},c}const J=(e,t)=>t.Buffer.from(e).toString("hex");function M(e,t,n){let s=t.response();s.tag=e.tag;const r=n.getResultsList();return s.events=r.reduce((e,n)=>{const s=J(n.getBlockId_asU8(),t),r=n.getBlockHeight(),o=n.getBlockTimestamp().toDate().toISOString();return n.getEventsList().forEach(n=>{e.push({blockId:s,blockHeight:r,blockTimestamp:o,type:n.getType(),transactionId:J(n.getTransactionId_asU8(),t),transactionIndex:n.getTransactionIndex(),eventIndex:n.getEventIndex(),payload:JSON.parse(t.Buffer.from(n.getPayload_asU8()).toString("utf8"))})}),e},[]),s}async function z(t,s={},r={}){e(r.node,"SDK Send Get Events Error: opts.node must be defined."),e(s.response,"SDK Send Get Events Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Events Error: context.Buffer must be defined.");const o=null!==(t=await t).events.start,a=Array.isArray(t.events.blockIds)&&t.events.blockIds.length>0;return e(o||a,"SendGetEventsError: Unable to determine which get events request to send. Either a block height range, or block IDs must be specified."),o?await async function(e,t,s){const r=s.unary||x,o=new p;return o.setType(e.events.eventType),o.setStartHeight(Number(e.events.start)),o.setEndHeight(Number(e.events.end)),M(e,t,await r(s.node,n.GetEventsForHeightRange,o,t))}(t,s,r):await async function(e,t,s){const r=s.unary||x,o=new S;o.setType(e.events.eventType),e.events.blockIds.forEach(e=>o.addBlockIds(((e,t)=>t.Buffer.from(e,"hex"))(e,t)));const a=await r(s.node,n.GetEventsForBlockIDs,o,t);return M(e,t,a)}(t,s,r)}const F=(e,t)=>t.Buffer.from(e).toString("hex");async function W(t,s={},r={}){e(r.node,"SDK Send Get Latest Block Error: opts.node must be defined."),e(s.response,"SDK Send Get Latest Block Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Latest Block Error: context.Buffer must be defined."),t=await t;const o=new l;t.latestBlock&&t.latestBlock.isSealed&&(o.setIsSealed(t.latestBlock.isSealed),console.error("\n          %c@onflow/send Deprecation Notice\n          ========================\n\n          Operating upon data of the latestBlock field of the interaction object is deprecated and will no longer be recognized in future releases of @onflow/send.\n          Find out more here: https://github.com/onflow/flow-js-sdk/blob/master/packages/send/WARNINGS.md#0001-Deprecating-latestBlock-field\n\n          =======================\n        ".replace(/\n\s+/g,"\n").trim(),"font-weight:bold;font-family:monospace;")),t.block&&t.block.isSealed&&o.setIsSealed(t.block.isSealed);const a=(await x(r.node,n.GetLatestBlock,o,s)).getBlock(),i=a.getCollectionGuaranteesList(),c=a.getBlockSealsList(),d=a.getSignaturesList(),u=s.response();return u.tag=t.tag,u.block={id:F(a.getId_asU8(),s),parentId:F(a.getParentId_asU8(),s),height:a.getHeight(),timestamp:a.getTimestamp(),collectionGuarantees:i.map(e=>({collectionId:F(e.getCollectionId_asU8(),s),signatures:e.getSignaturesList()})),blockSeals:c.map(e=>({blockId:F(e.getBlockId_asU8(),s),executionReceiptId:F(e.getExecutionReceiptId_asU8(),s),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()})),signatures:d},u}const X=(e,t)=>t.Buffer.from(e).toString("hex");async function V(t,s={},r={}){e(r.node,"SDK Send Get Transaction Error: opts.node must be defined."),e(s.response,"SDK Send Get Transaction Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Transaction Error: context.Buffer must be defined.");const o=r.unary||x;t=await t;const a=new m;a.setId(((e,t)=>t.Buffer.from(e,"hex"))(t.transaction.id,s));const i=await o(r.node,n.GetTransaction,a,s);let c=s.response();c.tag=t.tag;const d=e=>({address:X(e.getAddress_asU8(),s),keyId:e.getKeyId(),signature:X(e.getSignature_asU8(),s)});let u=i.getTransaction();var g;return c.transaction={script:s.Buffer.from(u.getScript_asU8()).toString("utf8"),args:u.getArgumentsList().map(e=>JSON.parse(s.Buffer.from(e).toString("utf8"))),referenceBlockId:X(u.getReferenceBlockId_asU8(),s),gasLimit:u.getGasLimit(),proposalKey:(g=u.getProposalKey(),{address:X(g.getAddress_asU8(),s),keyId:g.getKeyId(),sequenceNumber:g.getSequenceNumber()}),payer:X(u.getPayer_asU8(),s),authorizers:u.getAuthorizersList().map(e=>X(e,s)),payloadSignatures:u.getPayloadSignaturesList().map(d),envelopeSignatures:u.getEnvelopeSignaturesList().map(d)},c}const Z={0:"UNKNOWN",1:"PENDING",2:"FINALIZED",3:"EXECUTED",4:"SEALED",5:"EXPIRED"},Q=(e,t)=>t.Buffer.from(e).toString("hex");async function Y(t,s={},r={}){e(r.node,"SDK Send Get Transaction Status Error: opts.node must be defined."),e(s.response,"SDK Send Get Transaction Status Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Transaction Status Error: context.Buffer must be defined.");const o=r.unary||x;t=await t;const a=new m;a.setId(((e,t)=>t.Buffer.from(e,"hex"))(t.transaction.id,s));const i=await o(r.node,n.GetTransactionResult,a,s);let c=i.getEventsList(),d=s.response();return d.tag=t.tag,d.transactionStatus={status:i.getStatus(),statusString:Z[i.getStatus()],statusCode:i.getStatusCode(),errorMessage:i.getErrorMessage(),events:c.map(e=>({type:e.getType(),transactionId:Q(e.getTransactionId_asU8(),s),transactionIndex:e.getTransactionIndex(),eventIndex:e.getEventIndex(),payload:JSON.parse(s.Buffer.from(e.getPayload_asU8()).toString("utf8"))}))},d}async function $(t,s={},r={}){e(r.node,"SDK Send Ping Error: opts.node must be defined."),e(s.response,"SDK Send Ping Error: context.response must be defined.");const o=r.unary||x;t=await t;const a=new B;await o(r.node,n.Ping,a,s);let i=s.response();return i.tag=t.tag,i}const ee=(e,t)=>t.Buffer.from(e,"hex"),te=(e,t)=>((e,t,n)=>n.Buffer.from(e.padStart(16,0),"hex"))(e,0,t);async function ne(t,s={},r={}){e(r.node,"SDK Send Transaction Error: opts.node must be defined."),e(s.response,"SDK Send Transaction Error: context.response must be defined."),e(s.Buffer,"SDK Send Transaction Error: context.Buffer must be defined.");const o=r.unary||x;t=await t;const a=new k;a.setScript(((e,t)=>t.Buffer.from(e,"utf8"))(t.message.cadence,s)),a.setGasLimit(t.message.computeLimit),a.setReferenceBlockId(t.message.refBlock?ee(t.message.refBlock,s):null),a.setPayer(te(I(t.accounts[t.payer].addr),s)),t.message.arguments.forEach(e=>a.addArguments(((e,t)=>t.Buffer.from(JSON.stringify(e),"utf8"))(t.arguments[e].asArgument,s))),t.authorizations.map(e=>t.accounts[e].addr).reduce((e,t)=>e.find(e=>e===t)?e:[...e,t],[]).forEach(e=>a.addAuthorizers(te(I(e),s)));const i=new k.ProposalKey;i.setAddress(te(I(t.accounts[t.proposer].addr),s)),i.setKeyId(t.accounts[t.proposer].keyId),i.setSequenceNumber(t.accounts[t.proposer].sequenceNum),a.setProposalKey(i);for(let e of Object.values(t.accounts))try{if(!e.role.payer&&null!=e.signature){const t=new k.Signature;t.setAddress(te(I(e.addr),s)),t.setKeyId(e.keyId),t.setSignature(ee(e.signature,s)),a.addPayloadSignatures(t)}}catch(n){throw console.error("Trouble applying payload signature",{acct:e,ix:t}),n}for(let e of Object.values(t.accounts))try{if(e.role.payer&&null!=e.signature){const t=new k.Signature;t.setAddress(te(I(e.addr),s)),t.setKeyId(e.keyId),t.setSignature(ee(e.signature,s)),a.addEnvelopeSignatures(t)}}catch(n){throw console.error("Trouble applying envelope signature",{acct:e,ix:t}),n}const c=new y;c.setTransaction(a);var d=Date.now();const u=await o(r.node,n.SendTransaction,c,s);var g=Date.now();let l=s.response();return l.tag=t.tag,l.transactionId=((e,t)=>t.Buffer.from(e).toString("hex"))(u.getId_asU8(),s),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("FLOW::TX",{detail:{txId:l.transactionId,delta:g-d}})),l}const se=(e,t)=>t.Buffer.from(e).toString("hex"),re=(e,t)=>t.Buffer.from(e).toString("hex"),oe=async(t,s={},r={})=>{switch(e(r.node,'SDK Send Error: Either opts.node or "accessNode.api" in config must be defined.'),e(s.ix,"SDK Send Error: context.ix must be defined."),t=await t,!0){case s.ix.isTransaction(t):return r.sendTransaction?r.sendTransaction(t,s,r):ne(t,s,r);case s.ix.isGetTransactionStatus(t):return r.sendGetTransactionStatus?r.sendGetTransactionStatus(t,s,r):Y(t,s,r);case s.ix.isGetTransaction(t):return r.sendGetTransaction?r.sendGetTransaction(t,s,r):V(t,s,r);case s.ix.isScript(t):return r.sendExecuteScript?r.sendExecuteScript(t,s,r):D(t,s,r);case s.ix.isGetAccount(t):return r.sendGetAccount?r.sendGetAccount(t,s,r):U(t,s,r);case s.ix.isGetEvents(t):return r.sendGetEvents?r.sendGetEvents(t,s,r):z(t,s,r);case s.ix.isGetLatestBlock(t):return r.sendGetLatestBlock?r.sendGetLatestBlock(t,s,r):W(t,s,r);case s.ix.isGetBlock(t):return r.sendGetBlock?r.sendGetBlock(t,s,r):O(t,s,r);case s.ix.isGetBlockHeader(t):return r.sendGetBlockHeader?r.sendGetBlockHeader(t,s,r):R(t,s,r);case s.ix.isGetBlockById(t):return r.sendGetBlockById?r.sendGetBlockById(t,s,r):async function(t,s={},r={}){e(r.node,"SDK Send Get Block By ID Error: opts.node must be defined."),e(s.response,"SDK Send Get Block By ID Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Block By ID Error: context.Buffer must be defined."),t=await t;const o=new u;o.setId(((e,t)=>t.Buffer.from(e,"hex"))(t.block.id,s));const a=(await x(r.node,n.GetBlockByID,o,s)).getBlock(),i=a.getCollectionGuaranteesList(),c=a.getBlockSealsList(),d=a.getSignaturesList(),g=s.response();return g.tag=t.tag,g.block={id:se(a.getId_asU8(),s),parentId:se(a.getParentId_asU8(),s),height:a.getHeight(),timestamp:a.getTimestamp(),collectionGuarantees:i.map(e=>({collectionId:se(e.getCollectionId_asU8(),s),signatures:e.getSignaturesList()})),blockSeals:c.map(e=>({blockId:se(e.getBlockId_asU8(),s),executionReceiptId:se(e.getExecutionReceiptId_asU8(),s),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()})),signatures:d},g}(t,s,r);case s.ix.isGetBlockByHeight(t):return r.sendGetBlockByHeight?r.sendGetBlockByHeight(t,s,r):async function(t,s={},r={}){e(r.node,"SDK Send Get Block By Height Error: opts.node must be defined."),e(s.response,"SDK Send Get Block By Height Error: context.response must be defined."),e(s.Buffer,"SDK Send Get Block By Height Error: context.Buffer must be defined."),t=await t;const o=new g;o.setHeight(Number(t.block.height));const a=(await x(r.node,n.GetBlockByHeight,o,s)).getBlock(),i=a.getCollectionGuaranteesList(),c=a.getBlockSealsList(),d=a.getSignaturesList(),u=s.response();return u.tag=t.tag,u.block={id:re(a.getId_asU8(),s),parentId:re(a.getParentId_asU8(),s),height:a.getHeight(),timestamp:a.getTimestamp(),collectionGuarantees:i.map(e=>({collectionId:re(e.getCollectionId_asU8(),s),signatures:e.getSignaturesList()})),blockSeals:c.map(e=>({blockId:re(e.getBlockId_asU8(),s),executionReceiptId:re(e.getExecutionReceiptId_asU8(),s),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()})),signatures:d},u}(t,s,r);case s.ix.isGetCollection(t):return r.sendGetCollection?r.sendGetCollection(t,s,r):j(t,s,r);case s.ix.isPing(t):return r.sendPing?r.sendPing(t,s,r):$(t,s,r);default:return t}};export{oe as send,D as sendExecuteScript,U as sendGetAccount,O as sendGetBlock,R as sendGetBlockHeader,j as sendGetCollection,z as sendGetEvents,W as sendGetLatestBlock,V as sendGetTransaction,Y as sendGetTransactionStatus,$ as sendPing,ne as sendTransaction};
//# sourceMappingURL=sdk-send-grpc.modern.js.map
