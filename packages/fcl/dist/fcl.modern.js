import*as e from"@onflow/sdk";import{config as t,arg as n,send as r,getTransactionStatus as a,decode as s,resolve as o,pipe as i,interaction as c,createSignableVoucher as d,latestBlock as l,getEvents as u,encodeMessageFromSignable as p}from"@onflow/sdk";export{TestUtils,account,arg,args,atBlockHeight,atBlockId,authorization,authorizations,block,build,config,createSignableVoucher,decode,getAccount,getBlock,getBlockByHeight,getBlockById,getBlockHeader,getCollection,getEvents,getEventsAtBlockHeightRange,getEventsAtBlockIds,getLatestBlock,getTransaction,getTransactionStatus,invariant,isBad,isOk,latestBlock,limit,param,params,payer,ping,pipe,proposer,ref,script,send,transaction,validator,voucherIntercept,voucherToTxId,why}from"@onflow/sdk";import{invariant as f}from"@onflow/util-invariant";import*as y from"@onflow/types";import{spawn as h,send as g,SUBSCRIBE as m,UNSUBSCRIBE as E,INIT as w,subscriber as R,snapshoter as v,UPDATED as S,SNAPSHOT as b}from"@onflow/util-actor";import{withPrefix as C,sansPrefix as A}from"@onflow/util-address";export{display,sansPrefix,withPrefix}from"@onflow/util-address";import*as P from"@onflow/rlp";import{Buffer as I,encode as D}from"@onflow/rlp";import{uid as L}from"@onflow/util-uid";export{template as cadence,template as cdc}from"@onflow/util-template";const N="0.0.79-alpha.3",O={can:!("undefined"==typeof window),get:async e=>JSON.parse(sessionStorage.getItem(e)),put:async(e,t)=>sessionStorage.setItem(e,JSON.stringify(t))};async function k(e){return Object.fromEntries(Object.entries(await t().where(e)).map(([t,n])=>[t.replace(e,""),n]))}t({"discovery.wallet.method.default":"IFRAME/RPC","fcl.storage.default":O});const F=e=>t=>typeof t===e,T=e=>null!=e,_=F("object"),x=F("string"),U=F("function"),V=F("number");function M(t){return U(t)?t(e.arg,y):[]}async function H(t={}){return await async function(t){f(T(t.cadence),"query({ cadence }) -- cadence is required"),f(x(t.cadence),"query({ cadence }) -- cadence must be a string"),f(await e.config.get("accessNode.api"),'Required value for "accessNode.api" not defined in config. See: https://github.com/onflow/flow-js-sdk/blob/master/packages/fcl/src/exec/query.md#configuration')}(t),e.send([e.script(t.cadence),e.args(M(t.args||[])),t.limit&&"number"==typeof t.limit&&e.limit(t.limit)]).then(e.decode)}function j(){return j=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},j.apply(this,arguments)}const z={f_type:"Service",f_vsn:"1.0.0"},W={f_type:"Identity",f_vsn:"1.0.0"},K={f_type:"USER",f_vsn:"1.0.0"},B={f_type:"PollingResponse",f_vsn:"1.0.0"},Y={f_type:"CompositeSignature",f_vsn:"1.0.0"};function J(e){return null==e?null:"1.0.0"===e.f_vsn?e:j({old:e},z,{type:"frame",endpoint:e.endpoint,params:e.params||{},data:e.data||{}})}function $(e){return null==e?null:"1.0.0"===e.f_vsn?e:j({},z,{type:"back-channel-rpc",endpoint:e.endpoint,method:e.method,params:e.params||{},data:e.data||{}})}function q(e){return null==e?null:(null==e.method&&(e=j({},e,{type:"local-view",method:"VIEW/IFRAME"})),"1.0.0"===e.f_vsn?e:j({},z,{type:e.type||"local-view",method:e.method,endpoint:e.endpoint,data:e.data||{},params:e.params||{}}))}const G={"back-channel-rpc":$,"pre-authz":function(e){return null==e?null:"1.0.0"===e.f_vsn?e:j({},z,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:j({},W,{address:C(e.addr),keyId:e.keyId}),params:e.params,data:e.data})},authz:function(e){return null==e?null:"1.0.0"===e.f_vsn?e:j({},z,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:j({},W,{address:C(e.addr),keyId:e.keyId}),params:e.params,data:e.data})},authn:function(e){return null==e?null:"1.0.0"===e.f_vsn?e:j({},z,{type:e.type,uid:e.id,endpoint:e.authn,id:e.pid,provider:{address:C(e.addr),name:e.name,icon:e.icon}})},frame:J,"open-id":function(e){return null==e?null:"1.0.0"===e.f_vsn?e:null},"user-signature":function(e){if(null==e)return null;if("1.0.0"===e.f_vsn)return e;throw new Error("Invalid user-signature service")},"local-view":q,"account-proof":function(e){if(null==e)return null;if("1.0.0"===e.f_vsn)return e;throw new Error("Invalid account-proof service")},"authn-refresh":function(e){if(null==e)return null;if("1.0.0"===e.f_vsn)return e;throw new Error("Invalid authn-refresh service")}};function X(e){return P.encode([e.provider.address||e.provider.name||"UNSPECIFIED",e.id]).toString("hex")}async function Z(e){var t=function(e=[],t=[]){return[...e,...t]}((e=function(e){return e.addr=e.addr?C(e.addr):null,e.paddr=e.paddr?C(e.paddr):null,e}(e)).services||[],await async function(e,t){if(null==e||null==t)return[];const n=new URL(e);n.searchParams.append("code",t);const r=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json());if(Array.isArray(r))return r;const a=[];if(Array.isArray(r.authorizations))for(let e of r.authorizations)a.push(j({type:"authz",keyId:r.keyId},e));return null!=r.provider&&a.push(j({type:"authn",id:"wallet-provider#authn"},r.provider)),a}(e.hks,e.code)).map(t=>function(e,t){try{return G[e.type](e,t)}catch(t){return console.error(`Unrecognized FCL Service Type [${e.type}]`,e,t),e}}(t,e));const n=function(e,t){return t.find(e=>"authn"===e.type)}(0,t);return j({},K,{addr:C(e.addr),cid:X(n),loggedIn:!0,services:t,expiresAt:e.expires})}function Q(e=[],t){return e.find(e=>e.type===t)}function ee(e){const t=new URL(e.endpoint);if(t.searchParams.append("l6n",window.location.origin),null!=e.params)for(let[n,r]of Object.entries(e.params||{}))t.searchParams.append(n,r);return t}function te(e,t={}){const n=t.method||"POST",r="GET"===n?void 0:JSON.stringify(t.data||e.data||{});return fetch(ee(e),{method:n,headers:j({},e.headers||{},t.headers||{},{"Content-Type":"application/json"}),body:r}).then(e=>e.json())}function ne(e){var t,n;return null==e?null:"1.0.0"===e.f_vsn?e:j({},B,{status:null!=(t=e.status)?t:"APPROVED",reason:null!=(n=e.reason)?n:null,data:e.compositeSignature||e.data||j({},e)||{},updates:$(e.authorizationUpdates),local:J((e.local||[])[0])})}const re={"HTTP/GET":"GET","HTTP/POST":"POST"},ae=e=>(f(re[e.method],"Invalid Service Method for type back-channel-rpc",{service:e}),re[e.method]);async function se(e,t=(()=>!0)){if(f(e,"Missing Polling Service",{service:e}),!t())throw new Error("Externally Halted");const n=await te(e,{method:ae(e)}).then(ne);switch(n.status){case"APPROVED":return n.data;case"DECLINED":throw new Error(`Declined: ${n.reason||"No reason supplied."}`);default:return await new Promise(e=>setTimeout(e,500)),se(n.updates,t)}}const oe="FCL_IFRAME";function ie(e){f(!document.getElementById(oe),"Attempt at triggering multiple Frames",{src:e});const t=document.createElement("iframe");return t.src=e,t.id=oe,t.allow="usb *; hid *",t.frameBorder="0",t.style.cssText="\n  position:fixed;\n  top: 0px;\n  right: 0px;\n  bottom: 0px;\n  left: 0px;\n  height: 100%;\n  width: 100vw;\n  display:block;\n  background:rgba(0,0,0,0.25);\n  z-index: 2147483647;\n  box-sizing: border-box;\n",document.body.append(t),[t.contentWindow,()=>{document.getElementById(oe)&&document.getElementById(oe).remove()}]}let ce=null,de=null;function le(e){var t,n;return null==ce||null!=(t=ce)&&t.closed?(n=window,ce=n.open(e,"FCL_POP",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=770, top=${n.top.outerHeight/2+n.top.screenY-385}, left=${n.top.outerWidth/2+n.top.screenX-320}`)):de!==e?(ce.location.replace(e),ce.focus()):ce.focus(),de=e,[ce,()=>{ce&&!ce.closed&&ce.close(),ce=null}]}let ue=null,pe=null;function fe(e){var t;return null==ue||null!=(t=ue)&&t.closed?ue=window.open(e,"_blank"):pe!==e?(ue.location.replace(e),ue.focus()):ue.focus(),pe=e,[ue,()=>{ue&&!ue.closed&&ue.close(),ue=null}]}const ye={"VIEW/IFRAME":ie,"VIEW/POP":le,"VIEW/TAB":fe};async function he(e,t,n,r){const a=await te(e,{data:j({fclVersion:N,service:{params:e.params,data:e.data,type:e.type},config:r},t)}).then(ne);if("APPROVED"===a.status)return a.data;if("DECLINED"===a.status)throw new Error(`Declined: ${a.reason||"No reason supplied."}`);if("REDIRECT"===a.status)return a;if("PENDING"===a.status){var s=!0;const[e,t]=await async function(e,t={}){try{return ye[e.method](ee(e),t)}catch(n){throw console.error("execLocal({service, opts = {}})",n,{service:e,opts:t}),n}}(q(a.local)),n=()=>{try{t(),s=!1}catch(e){console.error("Frame Close Error",e)}};return se(a.updates,()=>s).then(e=>(n(),e)).catch(e=>{throw console.error(e),n(),e})}throw console.error("Auto Decline: Invalid Response",{service:e,resp:a}),new Error("Auto Decline: Invalid Response")}const ge=e=>"string"==typeof e&&e.toLowerCase(),me=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]),Ee=(e,t)=>console.warn("DEPRECATION NOTICE",`Received ${e}, please use ${t} for this and future versions of FCL`),we=({close:e,send:t,onReady:n,onResponse:r,onMessage:a})=>s=>{try{if("object"!=typeof s.data)return;if(me.has(s.data.type))return;ge(s.data.type)===ge("FCL:VIEW:CLOSE")&&e(),ge(s.data.type)===ge("FCL:VIEW:READY")&&n(s,{send:t,close:e}),ge(s.data.type)===ge("FCL:VIEW:RESPONSE")&&r(s,{send:t,close:e}),a(s,{send:t,close:e}),ge(s.data.type)===ge("FCL:FRAME:READY")&&(Ee(s.data.type,"FCL:VIEW:READY"),n(s,{send:t,close:e})),ge(s.data.type)===ge("FCL:FRAME:RESPONSE")&&(Ee(s.data.type,"FCL:VIEW:RESPONSE"),r(s,{send:t,close:e})),ge(s.data.type)===ge("FCL:FRAME:CLOSE")&&(Ee(s.data.type,"FCL:VIEW:CLOSE"),e()),ge(s.data.type)===ge("FCL::CHALLENGE::RESPONSE")&&(Ee(s.data.type,"FCL:VIEW:RESPONSE"),r(s,{send:t,close:e})),ge(s.data.type)===ge("FCL::AUTHZ_READY")&&(Ee(s.data.type,"FCL:VIEW:READY"),n(s,{send:t,close:e})),ge(s.data.type)===ge("FCL::CHALLENGE::CANCEL")&&(Ee(s.data.type,"FCL:VIEW:CLOSE"),e()),ge(s.data.type)===ge("FCL::CANCEL")&&(Ee(s.data.type,"FCL:VIEW:CLOSE"),e())}catch(t){console.error("Frame Callback Error",t),e()}},Re=()=>{},ve=()=>{},Se=()=>{},be=()=>{},Ce={"HTTP/RPC":he,"HTTP/POST":he,"IFRAME/RPC":function(e,t,n,r){return new Promise((a,s)=>{var o;const i=L(),c=n.includeOlderJsonRpcCall;t.data=null!=(o=e.data)?o:null,function(e,t={}){if(null==e)return{send:Re,close:Re};const n=t.onClose||Re;window.addEventListener("message",we({close:s,send:o,onReady:t.onReady||Re,onResponse:t.onResponse||Re,onMessage:t.onMessage||Re}));const[r,a]=ie(ee(e));return{send:o,close:s};function s(){try{window.removeEventListener("message",we),a(),n()}catch(e){console.error("Frame Close Error",e)}}function o(e){try{r.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Frame Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({type:"FCL:VIEW:READY:RESPONSE",fclVersion:N,body:t,service:{params:e.params,data:e.data,type:e.type},config:r}),a({fclVersion:N,type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data,type:e.type},config:r,deprecated:{message:"FCL:FRAME:READY:RESPONSE is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}}),c&&a({jsonrpc:"2.0",id:i,method:"fcl:sign",params:[t,e.params],deprecated:{message:"jsonrpc is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=ne(e.data);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":s(`Declined: ${n.reason||"No reason supplied"}`),t();break;case"REDIRECT":a(n),t();break;default:s("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==i)return;const n=ne(e.data.result);switch(n.status){case"APPROVED":a(n.data),t();break;case"DECLINED":s(`Declined: ${n.reason||"No reason supplied"}`),t();break;case"REDIRECT":a(n),t();break;default:s("Declined: No reason supplied"),t()}}catch(e){throw console.error("execIframeRPC onMessage error",e),e}},onClose(){s("Declined: Externally Halted")}})})},"POP/RPC":function(e,t,n,r){return new Promise((a,s)=>{const o=L(),{redir:i,includeOlderJsonRpcCall:c}=n;t.data=e.data,function(e,t={}){if(null==e)return{send:ve,close:ve};const n=t.onClose||ve;window.addEventListener("message",we({close:o,send:i,onReady:t.onReady||ve,onResponse:t.onResponse||ve,onMessage:t.onMessage||ve}));const[r,a]=le(ee(e)),s=setInterval(function(){r&&r.closed&&o()},500);return{send:i,close:o};function o(){try{window.removeEventListener("message",we),clearInterval(s),a(),n()}catch(e){console.error("Popup Close Error",e)}}function i(e){try{r.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Popup Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({fclVersion:N,type:"FCL:VIEW:READY:RESPONSE",body:t,service:{params:e.params,data:e.data,type:e.type},config:r}),a({fclVersion:N,type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data,type:e.type},config:r,deprecated:{message:"FCL:FRAME:READY:RESPONSE is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}}),c&&a({jsonrpc:"2.0",id:o,method:"fcl:sign",params:[t,e.params]})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=ne(e.data);switch(n.status){case"APPROVED":a(n.data),!i&&t();break;case"DECLINED":s(`Declined: ${n.reason||"No reason supplied"}`),t();break;case"REDIRECT":a(n),t();break;default:s("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==o)return;const n=ne(e.data.result);switch(n.status){case"APPROVED":a(n.data),!i&&t();break;case"DECLINED":s(`Declined: ${n.reason||"No reason supplied"}`),t();break;case"REDIRECT":a(n),t();break;default:s("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onMessage error",e),e}},onClose(){s("Declined: Externally Halted")}})})},"TAB/RPC":function(e,t,n,r){return new Promise((a,s)=>{const o=L(),{redir:i,includeOlderJsonRpcCall:c}=n;t.data=e.data,function(e,t={}){if(null==e)return{send:Se,close:Se};const n=t.onClose||Se;window.addEventListener("message",we({close:o,send:i,onReady:t.onReady||Se,onResponse:t.onResponse||Se,onMessage:t.onMessage||Se}));const[r,a]=fe(ee(e)),s=setInterval(function(){r&&r.closed&&o()},500);return{send:i,close:o};function o(){try{window.removeEventListener("message",we),clearInterval(s),a(),n()}catch(e){console.error("Tab Close Error",e)}}function i(e){try{r.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Tab Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({fclVersion:N,type:"FCL:VIEW:READY:RESPONSE",body:t,service:{params:e.params,data:e.data,type:e.type},config:r}),a({fclVersion:N,type:"FCL:FRAME:READY:RESPONSE",body:t,service:{params:e.params,data:e.data,type:e.type},config:r,deprecated:{message:"FCL:FRAME:READY:RESPONSE is deprecated and replaced with type: FCL:VIEW:READY:RESPONSE"}}),c&&a({jsonrpc:"2.0",id:o,method:"fcl:sign",params:[t,e.params]})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const n=ne(e.data);switch(n.status){case"APPROVED":a(n.data),!i&&t();break;case"DECLINED":s(`Declined: ${n.reason||"No reason supplied"}`),t();break;case"REDIRECT":a(n),t();break;default:s("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onResponse error",e),e}},onMessage(e,{close:t}){try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==o)return;const n=ne(e.data.result);switch(n.status){case"APPROVED":a(n.data),!i&&t();break;case"DECLINED":s(`Declined: ${n.reason||"No reason supplied"}`),t();break;case"REDIRECT":a(n),t();break;default:s("Declined: No reason supplied"),t()}}catch(e){throw console.error("execPopRPC onMessage error",e),e}},onClose(){s("Declined: Externally Halted")}})})},"EXT/RPC":function(e,t,n,r){return new Promise((n,a)=>{!function(e,t={}){if(null==e)return{send:be,close:be};const n=t.onClose||be;return window.addEventListener("message",we({close:r,send:a,onReady:t.onReady||be,onResponse:t.onResponse||be,onMessage:t.onMessage||be})),a({service:e}),{send:a,close:r};function r(){try{window.removeEventListener("message",we),n()}catch(e){console.error("Ext Close Error",e)}}function a(e){try{window&&window.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(t){console.error("Ext Send Error",e,t)}}}(e,{async onReady(n,{send:a}){try{a({fclVersion:N,type:"FCL:VIEW:READY:RESPONSE",body:t,service:{params:e.params,data:e.data,type:e.type},config:r})}catch(e){throw e}},onResponse(e,{close:t}){try{if("object"!=typeof e.data)return;const r=ne(e.data);switch(r.status){case"APPROVED":n(r.data),t();break;case"DECLINED":a(`Declined: ${r.reason||"No reason supplied"}`),t();break;case"REDIRECT":n(r),t();break;default:a("Declined: No reason supplied"),t()}}catch(e){throw console.error("execExtRPC onResponse error",e),e}},onClose(){a("Declined: Externally Halted")}})})}};async function Ae({service:e,msg:t={},opts:n={},config:r={}}){var a,s,o;const i=j({},r,{services:await k(/^service\./),app:await k(/^app\.detail\./),client:{fclVersion:N,fclLibrary:"https://github.com/onflow/fcl-js",hostname:null!=(a=null==(s=window)||null==(o=s.location)?void 0:o.hostname)?a:null}});try{const r=await Ce[e.method](e,t,n,i);return"REDIRECT"===r.status?(f(e.type===r.data.type,"Cannot shift recursive service type in execService"),await Ae({service:r.data,msg:t,opts:n,config:i})):r}catch(a){throw console.error("execService({service, msg = {}, opts = {}, config = {}})",a,{service:e,msg:t,opts:n,config:r}),a}}async function Pe(e,t){((e,t)=>{f(/^[0-9a-f]+$/i.test(e),"Signed message must be a hex string"),f(Array.isArray(t)&&t.every((e,t,n)=>"CompositeSignature"===e.f_type),"Must include an Array of CompositeSignatures to verify"),f(t.map(e=>e.addr).every((e,t,n)=>e===n[0]),"User signatures to be verified must be from a single account address")})(e,t);const n=t[0].addr;let r=[],a=[];return t.map(e=>{r.push(e.signature),a.push(e.keyId)}),await H({cadence:Ie,args:(t,s)=>[t(n,s.Address),t(e,s.String),t(a,s.Array([s.Int])),t(r,s.Array([s.String]))]})}const Ie='\n  import Crypto\n\n  pub fun getHashAlgo(_ x: Int): HashAlgorithm {\n    switch x {\n    case 1:\n        return HashAlgorithm.SHA2_256\n    case 2:\n        return HashAlgorithm.SHA2_384\n    case 3:\n        return HashAlgorithm.SHA3_256\n    case 4:\n        return HashAlgorithm.SHA3_384\n    case 5:\n        return HashAlgorithm.KMAC128_BLS_BLS12_381\n    default:\n        return HashAlgorithm.SHA3_256\n    }\n  }\n      \n  pub fun main(\n    acctAddress: Address,\n    message: String,\n    keyIds: [Int],\n    signatures: [String],\n  ): Bool {\n\n    let keyList = Crypto.KeyList()\n    let account = getAccount(acctAddress)\n    \n    let rawPublicKeys: [String] = []\n    let weights: [UFix64] = []\n    let signAlgos: [UInt] = []\n    let hashAlgos: [UInt] = []\n    let uniqueKeys: {Int: Bool} = {}\n    \n    for id in keyIds {\n      uniqueKeys[id] = true\n    }\n\n    assert(uniqueKeys.keys.length == keyIds.length, message: "Invalid KeyId: Duplicate key found for account")\n\n    var counter = 0\n    while (counter < keyIds.length) {\n      let accountKey = account.keys.get(keyIndex: keyIds[counter]) ?? panic("Key provided does not exist on account")\n      rawPublicKeys.append(String.encodeHex(accountKey.publicKey.publicKey))\n      weights.append(accountKey.weight)\n      signAlgos.append(UInt(accountKey.publicKey.signatureAlgorithm.rawValue))\n      hashAlgos.append(UInt(accountKey.hashAlgorithm.rawValue))\n      counter = counter + 1\n    }\n\n    var totalWeight = 0.0\n    for weight in weights {\n      totalWeight = totalWeight + weight\n    }\n    \n    assert(totalWeight >= 900.0, message: "Signature key weights do not meet threshold >= 900.0")\n\n    var i = 0\n    for rawPublicKey in rawPublicKeys {\n      keyList.add(\n        PublicKey(\n          publicKey: rawPublicKey.decodeHex(),\n          signatureAlgorithm: signAlgos[i] == 2 ? SignatureAlgorithm.ECDSA_secp256k1  : SignatureAlgorithm.ECDSA_P256\n        ),\n        hashAlgorithm: getHashAlgo(Int(hashAlgos[i])),\n        weight: weights[i]\n      )\n      i = i + 1\n    }\n\n    let signatureSet: [Crypto.KeyListSignature] = []\n\n    var j = 0\n    for signature in signatures {\n      signatureSet.append(\n        Crypto.KeyListSignature(\n          keyIndex: j,\n          signature: signature.decodeHex()\n        )\n      )\n      j = j + 1\n    }\n      \n    let signedData = message.decodeHex()\n    \n    return keyList.verify(\n      signatureSet: signatureSet,\n      signedData: signedData\n    )\n  }\n';function De(e){return null==e?null:"1.0.0"===e.f_vsn?e:j({},Y,{addr:A(e.addr||e.address),signature:e.signature||e.sig,keyId:e.keyId})}const Le="CURRENT_USER",Ne="CURRENT_USER/UPDATED",Oe='{\n  "f_type": "User",\n  "f_vsn": "1.0.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "expiresAt":null,\n  "services":[]\n}',ke={[w]:async e=>{"undefined"==typeof window&&console.warn('\n        %cFCL Warning\n        ============================\n        "currentUser" is only available in the browser.\n        For more info, please see the docs: https://docs.onflow.org/fcl/\n        ============================\n        ',"font-weight:bold;font-family:monospace;"),e.merge(JSON.parse(Oe));const n=await t.first(["fcl.storage","fcl.storage.default"]);if(n.can){const t=await(async e=>{const t=JSON.parse(Oe),n=await e.get(Le);return null!=n&&t.f_vsn!==n.f_vsn?(e.removeItem(Le),t):n||t})(n);(function(e){return null==e.expiresAt||0===e.expiresAt||e.expiresAt>Date.now()})(t)&&e.merge(t)}},[m]:(e,t)=>{e.subscribe(t.from),e.send(t.from,Ne,j({},e.all()))},[E]:(e,t)=>{e.unsubscribe(t.from)},SNAPSHOT:async(e,t)=>{t.reply(j({},e.all()))},SET_CURRENT_USER:async(e,n,r)=>{e.merge(r);const a=await t.first(["fcl.storage","fcl.storage.default"]);a.can&&a.put(Le,e.all()),e.broadcast(Ne,j({},e.all()))},DEL_CURRENT_USER:async(e,n)=>{e.merge(JSON.parse(Oe));const r=await t.first(["fcl.storage","fcl.storage.default"]);r.can&&r.put(Le,e.all()),e.broadcast(Ne,j({},e.all()))}},Fe=()=>h(ke,Le);async function Te({service:e,redir:n=!1}={}){return new Promise(async(r,a)=>{Fe();const s=await Ve(),o=await async function(){return{timestamp:Date.now(),appDomainTag:await t.get("fcl.appDomainTag"),extensions:window.fcl_extensions||[]}}(),i={redir:n},c=await async function(){const e=await t.first(["discovery.wallet","challenge.handshake"]),n=await t.get("discovery.authn.include",[]);return{type:"authn",endpoint:e,method:await t.first(["discovery.wallet.method","discovery.wallet.method.default"]),discoveryAuthnInclude:n}}(),d=Q(s.services,"authn-refresh");if(f(e||c.endpoint,'\n        If no service passed to "authenticate," then "discovery.wallet" must be defined in config.\n        See: "https://docs.onflow.org/fcl/reference/api/#setting-configuration-values"\n      '),s.loggedIn){if(!d)return r(s);try{const e=await Ae({service:d,msg:o,opts:i});g(Le,"SET_CURRENT_USER",await Z(e))}catch(e){console.error("Error: Could not refresh authentication.",e)}finally{return r(await Ve())}}try{const t=await Ae({service:j({},e||c,{method:(null==c?void 0:c.method)||e.method||"IFRAME/RPC"}),msg:o,opts:i,config:{discoveryAuthnInclude:c.discoveryAuthnInclude}});g(Le,"SET_CURRENT_USER",await Z(t))}catch(e){console.error("Error while authenticating",e)}finally{r(await Ve())}})}function _e(){Fe(),g(Le,"DEL_CURRENT_USER")}async function xe(e){return Fe(),j({},e,{tempId:"CURRENT_USER",async resolve(e,t){const n=await Te({redir:!0}),r=Q(n.services,"authz"),a=Q(n.services,"pre-authz");if(a)return function(e){const t=(e=>({f_type:"PreAuthzResponse",f_vsn:"1.0.0",proposer:(e||{}).proposer,payer:(e||{}).payer||[],authorization:(e||{}).authorization||[]}))(e),n=[];null!=t.proposer&&n.push(["PROPOSER",t.proposer]);for(let e of t.payer||[])n.push(["PAYER",e]);for(let e of t.authorization||[])n.push(["AUTHORIZER",e]);return n.map(([e,t])=>({tempId:[t.identity.address,t.identity.keyId].join("|"),addr:t.identity.address,keyId:t.identity.keyId,signingFunction:e=>Ae({service:t,msg:e}),role:{proposer:"PROPOSER"===e,payer:"PAYER"===e,authorizer:"AUTHORIZER"===e}}))}(await Ae({service:a,msg:t}));if(r)return j({},e,{tempId:"CURRENT_USER",resolve:null,addr:A(r.identity.address),keyId:r.identity.keyId,sequenceNum:null,signature:null,signingFunction:async e=>De(await Ae({service:r,msg:e,opts:{includeOlderJsonRpcCall:!0}}))});throw new Error("No Authz or PreAuthz Service configured for CURRENT_USER")}})}function Ue(e){Fe();const t="@EXIT",n=h(async n=>{for(n.send(Le,m);;){const r=await n.receive();if(r.tag===t)return void n.send(Le,E);e(r.data)}});return()=>g(n,t)}function Ve(){return Fe(),g(Le,"SNAPSHOT",null,{expectReply:!0,timeout:0})}async function Me(){const{addr:e}=await Te();return n(C(e),y.Address)}const He=e=>(f(/^[0-9a-f]+$/i.test(e),"Message must be a hex string"),{message:e});async function je(e){Fe();const t=Q((await Te({redir:!0})).services,"user-signature");f(t,"Current user must have authorized a signing service.");try{const n=await Ae({service:t,msg:He(e)});return Array.isArray(n)?n.map(e=>De(e)):[De(n)]}catch(e){return e}}async function ze(e,t){return console.warn("\n    %cFCL/SDK Deprecation Notice\n    ============================\n    verifyUserSignatures is no longer exported as fcl.currentUser().verifyUserSignatures\n    and is now available as fcl.verifyUserSignatures\n    ============================\n    ","font-weight:bold;font-family:monospace;"),Pe(e,t)}let We=()=>({authenticate:Te,unauthenticate:_e,authorization:xe,signUserMessage:je,verifyUserSignatures:ze,subscribe:Ue,snapshot:Ve,resolveArgument:Me});We.authenticate=Te,We.unauthenticate=_e,We.authorization=xe,We.signUserMessage=je,We.verifyUserSignatures=ze,We.subscribe=Ue,We.snapshot=Ve,We.resolveArgument=Me;const Ke=async e=>r([a(e)]).then(s),Be=e=>e.status>=4,Ye=e=>e.status>=3,Je=e=>e.status>=2,$e={[w]:async e=>{const t=await Ke(e.self());Be(t)||setTimeout(()=>e.sendSelf("POLL"),2500),e.merge(t)},[m]:(e,t)=>{e.subscribe(t.from),e.send(t.from,S,e.all())},[E]:(e,t)=>{e.unsubscribe(t.from)},[b]:async(e,t)=>{t.reply(e.all())},POLL:async e=>{const t=await Ke(e.self());var n,r;Be(t)||setTimeout(()=>e.sendSelf("POLL"),2500),n=e.all(),r=t,JSON.stringify(n)!==JSON.stringify(r)&&e.broadcast(S,t),e.merge(t)}},qe=e=>{if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},Ge=e=>h($e,qe(e));function Xe(e){function t(t){return R(qe(e),Ge,t)}function n(e){return function(n={}){const r=n.suppress||!1;return new Promise((n,a)=>{const s=t(t=>{t.statusCode&&!r?(a(t.errorMessage),s()):e(t)&&(n(t),s())})})}}return{snapshot:function(){return v(e,Ge)},subscribe:t,onceFinalized:n(Je),onceExecuted:n(Ye),onceSealed:n(Be)}}async function Ze(t={}){var n;try{await async function(t){f(T(t),"mutate(opts) -- opts is required"),f(_(t),"mutate(opts) -- opts must be an object"),f(T(t.cadence),"mutate({ cadence }) -- cadence is required"),f(x(t.cadence),"mutate({ cadence }) -- cadence must be a string"),f(await e.config.get("accessNode.api"),'Required value for "accessNode.api" not defined in config. See: https://github.com/onflow/flow-js-sdk/blob/master/packages/fcl/src/exec/query.md#configuration')}(t);const r=await e.config().get("fcl.authz",We().authorization);return n=e.send([e.transaction(t.cadence),e.args(M(t.args||[])),t.limit&&V(t.limit)&&e.limit(t.limit),e.proposer(t.proposer||t.authz||r),e.payer(t.payer||t.authz||r),e.authorizations(t.authorizations||[t.authz||r])]).then(e.decode),n}catch(e){throw e}}Xe.isUnknown=e=>e.status>=0,Xe.isPending=e=>e.status>=1,Xe.isFinalized=Je,Xe.isExecuted=Ye,Xe.isSealed=Be,Xe.isExpired=e=>5===e.status;const Qe=async(e=[],n={})=>{const r=await t.first(["sdk.resolve"],n.resolve||o);return Array.isArray(e)&&(e=await i(c(),e)),JSON.stringify(d(await r(e)),null,2)},et=async e=>setTimeout(()=>e.sendSelf("TICK"),await t().get("fcl.eventPollRate",1e4)),tt={TICK:async e=>{if(!e.hasSubs())return;let t=e.get("hwm");if(null==t)e.put("hwm",await l()),e.put("tick",await et(e));else{let n=await l();e.put("hwm",n);const a=await r([u(e.self(),t.height,n.height-1)]).then(s);for(let t of a)e.broadcast("UPDATED",t.data);e.put("tick",await et(e))}},[m]:async(e,t)=>{e.hasSubs()||e.put("tick",await et(e)),e.subscribe(t.from)},[E]:(e,t)=>{e.unsubscribe(t.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))}},nt=e=>h(tt,e);function rt(e){return{subscribe:t=>R(e,nt,t)}}async function at(e=[]){const n=await t.get("discovery.authn.endpoint");f(Boolean(n),'"discovery.authn.endpoint" in config must be defined.');const r=await t.get("discovery.authn.include",[]),a=new URL(n);return fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fclVersion:N,include:r})}).then(e=>e.json()).then(t=>[...e,...t])}function st(e=[]){return[...window.fcl_extensions||[],...e]}const ot={[w]:async e=>{"undefined"==typeof window&&console.warn('\n      %cFCL Warning\n      ============================\n      "fcl.discovery" is only available in the browser.\n      For more info, please see the docs: https://docs.onflow.org/fcl/\n      ============================\n      ',"font-weight:bold;font-family:monospace;");const t=await(({type:e})=>((...e)=>t=>e.reduce((e,t)=>e.then(t),Promise.resolve(t)))(at,st,t=>function(e=[],t){return e.filter(e=>e.type===t)}(t,e))([]))({type:"authn"});e.put("results",t)},[m]:(e,t)=>{e.subscribe(t.from),e.send(t.from,"UPDATED",j({},e.all()))},[E]:(e,t)=>e.unsubscribe(t.from),SNAPSHOT:async(e,t)=>t.reply(j({},e.all()))},it=()=>h(ot,"authn"),ct={authn:{subscribe:e=>R("authn",it,e),snapshot:()=>v("authn",it)}},dt=(e,t=(()=>{}))=>{const n=n=>{const{data:r}=n;"object"==typeof r&&null!=typeof r&&r.type===e&&t((e=>{var t;return e.deprecated&&console.warn("DEPRECATION NOTICE",e.deprecated.message),null==e||null==(t=e.body)||delete t.interaction,e})(r))};return window.addEventListener("message",n),()=>window.removeEventListener("message",n)},lt=(e,t={})=>{window.location!==window.parent.location?window.parent.postMessage(j({},t,{type:e}),"*"):window.opener.postMessage(j({},t,{type:e}),"*")},ut=(e,t)=>I.from(e.padEnd(2*t,0),"hex"),pt=e=>I.from(e.padStart(16,0),"hex"),ft=e=>I.from(e.padStart(16,0),"hex");var yt={__proto__:null,sendMsgToFCL:lt,ready:(e,t={})=>{dt("FCL:VIEW:READY:RESPONSE",e),lt("FCL:VIEW:READY")},close:()=>{lt("FCL:VIEW:CLOSE")},approve:e=>{lt("FCL:VIEW:RESPONSE",{f_type:"PollingResponse",f_vsn:"1.0.0",status:"APPROVED",reason:null,data:e})},decline:e=>{lt("FCL:VIEW:RESPONSE",{f_type:"PollingResponse",f_vsn:"1.0.0",status:"DECLINED",reason:e,data:null})},redirect:e=>{lt("FCL:VIEW:RESPONSE",{f_type:"PollingResponse",f_vsn:"1.0.0",status:"REDIRECT",reason:null,data:e})},onMessageFromFCL:dt,encodeMessageFromSignable:p,CompositeSignature:function(e,t,n){this.f_type=Y.f_type,this.f_vsn=Y.f_vsn,this.addr=C(e),this.keyId=Number(t),this.signature=n},encodeMessageForProvableAuthnSigning:(e,t,n="")=>{f(e,"Encode Message For Provable Authn Error: address must be defined"),f(t,"Encode Message For Provable Authn Error: timestamp must be defined");const r=ut(I.from("FLOW-V0.0-user").toString("hex"),32),a=n?ut(I.from(n).toString("hex"),32):null;return I.concat([r,D(n?[a,pt(A(e)),t]:[pt(A(e)),t])]).toString("hex")},encodeMessageForProvableAuthnVerifying:(e,t,n="")=>{f(e,"Encode Message For Provable Authn Error: address must be defined"),f(t,"Encode Message For Provable Authn Error: timestamp must be defined");const r=n?(a=I.from(n).toString("hex"),I.from(a.padEnd(64,0),"hex")):null;var a;return D(n?[r,ft(A(e)),t]:[ft(A(e)),t]).toString("hex")},injectExtService:function(e){"authn"===e.type&&null!=e.endpoint?(Array.isArray(window.fcl_extensions)||(window.fcl_extensions=[]),window.fcl_extensions.push(e)):console.warn("Authn service is required")}};const ht=(e={})=>We().authenticate(e),gt=()=>We().unauthenticate(),mt=(e={})=>(We().unauthenticate(),We().authenticate(e)),Et=(e={})=>We().authenticate(e),wt=(e={})=>We().authenticate(e),Rt=We().authorization,vt=y;export{N as VERSION,yt as WalletUtils,ht as authenticate,Rt as authz,We as currentUser,ct as discovery,rt as events,wt as logIn,Ze as mutate,H as query,mt as reauthenticate,Qe as serialize,Et as signUp,vt as t,Xe as tx,gt as unauthenticate,Pe as verifyUserSignatures};
//# sourceMappingURL=fcl.modern.js.map
